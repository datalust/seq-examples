services:
  seq1:
    image: datalust/seq:preview
    hostname: seq1
    networks:
      - seqclusterdemo
    volumes:
      - ./seq1init.sh:/seqinit/seq1init.sh
      - ./seq1data:/data
    ports:
      - 5399:80
      - 1082:1082
    environment: 
      - ACCEPT_EULA=Y
      - "SEQ_METASTORE_POSTGRES_CONNECTIONSTRING=Server=pgseq;Port=5432;Database=seq;User Id=postgres;Password=terminatorx;"
      - SEQ_API_CANONICALURI=http://localhost:5666
      - SEQ_CLUSTER_NODENAME=alpha
      - SEQ_CLUSTER_ISENABLED=true
      - SEQ_CLUSTER_CLUSTERLISTENURI=ws://seq1:1082
      - SEQ_CLUSTER_INTERNALAPIURI=http://seq1
    healthcheck:
      test: "/seqsvr/Client/seqcli node health -s http://localhost"
      interval: 15s
      timeout: 10s
      retries: 2
      start_period: 5s


  seq2:
    image: datalust/seq:preview
    hostname: seq2
    networks:
      - seqclusterdemo
    volumes:
      - ./seq2init.sh:/seqinit/seq2init.sh
      - ./seq2data:/data
    ports:
      - 5398:80
      - 1081:1081
    environment: 
      - ACCEPT_EULA=Y
      - 'SEQ_METASTORE_POSTGRES_CONNECTIONSTRING=Server=pgseq;Port=5432;Database=seq;Username=postgres;Password=terminatorx;'
      - SEQ_API_CANONICALURI=http://localhost:5666
      - SEQ_CLUSTER_NODENAME=beta
      - SEQ_CLUSTER_ISENABLED=true
      - SEQ_CLUSTER_CLUSTERLISTENURI=ws://seq2:1081
      - SEQ_CLUSTER_INTERNALAPIURI=http://seq2
    healthcheck:
      test: "/seqsvr/Client/seqcli node health -s http://localhost"
      interval: 15s
      timeout: 10s
      retries: 2
      start_period: 5s

  seq1setlicense:
    image: datalust/seqcli
    networks:
      - seqclusterdemo
    depends_on:
      seq1:
        condition: service_healthy
    restart: "no"
    volumes:
      - ./cert.txt:/data/cert.txt
    entrypoint:
      - /bin/seqcli/seqcli 
      - license 
      - apply 
      - --certificate=/data/cert.txt
      - -s http://seq1

  proxy:
    image: nginx
    volumes:
      - ./default.conf:/etc/nginx/conf.d/default.conf
    networks:
      - seqclusterdemo
    depends_on:
      seq1:
        condition: service_healthy
      seq2:
        condition: service_healthy
    ports:
      - "5666:5666"

  pgseq:
    image: postgres:14
    hostname: pgseq
    networks:
      - seqclusterdemo
    ports:
      - 5433:5432
    environment: 
      - POSTGRES_USER=postgres
      - POSTGRES_DB=seq
      - POSTGRES_PASSWORD=terminatorx


networks:
  seqclusterdemo: {}